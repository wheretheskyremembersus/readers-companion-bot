<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Our Story ‚Äî Readers‚Äô Companion</title>

<style>
/* =========================
   GLOBAL PAGE (Canva-like)
========================= */
body {
  margin: 0;
  font-family: "Palatino Linotype", Palatino, "Book Antiqua", serif;
  background: linear-gradient(
    to bottom,
    #bfc2c4 0%,
    #e4e6e7 35%,
    #ffffff 100%
  );
  color: #222;
}

.page-wrapper {
  max-width: 1200px;
  margin: 0 auto;
  padding: 60px 40px 80px;
}

/* =========================
   TWO-COLUMN LAYOUT
========================= */
.layout {
  display: grid;
  grid-template-columns: 520px 1fr;
  gap: 80px;
  align-items: flex-start;
}

/* =========================
   HEADER
========================= */
.page-header {
  margin-bottom: 32px;
}

.page-header h1 {
  font-size: 22px;
  font-weight: normal;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #555;
  margin: 0 0 10px 0;
}

.page-header p {
  margin: 0;
  font-size: 15px;
  color: #777;
}

/* =========================
   BOT SHELL
========================= */
.bot-shell {
  background: #ffffff;
  border-radius: 20px;
  box-shadow:
    0 30px 70px rgba(0,0,0,0.15),
    0 10px 25px rgba(0,0,0,0.08);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.04);
}

/* =========================
   BOT HEADER
========================= */
.bot-header {
  background: linear-gradient(135deg, #f3f5f7, #e9edf2);
  padding: 20px 24px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.04);
  transition: background 0.4s ease;
}

.bot-title {
  font-size: 20px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #2a2a2a;
  font-weight: 500;
}

.chat-body {
  position: relative;
  max-height: 420px;
  overflow-y: auto;   /* keep scrolling */
  overflow-x: hidden; /* prevent horizontal shift */
  padding: 22px 24px 14px 24px;
  font-size: 14px;
  line-height: 1.7;
  border-radius: 0 0 20px 20px;
  background: transparent; /* IMPORTANT */
}

.sky-layer {
  position: fixed;          /* <-- THIS is the key change */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  z-index: -1;              /* sits behind everything */

  opacity: 0;

  transition:
    opacity 1.5s ease,
    transform 2s ease,
    filter 2s ease;
}

/* Overlay */
.chat-body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,var(--overlayStrength,0.35));
  backdrop-filter: blur(1.5px);
  pointer-events: none;
  z-index: 1;
  transition: background 1.5s ease, backdrop-filter 1.5s ease;
}
   
/* MESSAGE FIX */
.message {
  position: relative;
  display: flex;          /* THIS was likely lost */
  width: 100%;
  margin-bottom: 14px;    /* THIS fixes bubble touching */
  z-index: 2;
}

/* =========================
   CHAT BUBBLES
========================= */
.bubble {
  max-width: 80%;
  padding: 14px 18px;
  border-radius: 18px;
  box-shadow:
    0 2px 6px rgba(0,0,0,0.06),
    0 1px 0 rgba(255,255,255,0.4) inset;
  word-wrap: break-word;
}

/* Alignments */
.user {
  justify-content: flex-end;
}

.saira-msg,
.aayan-msg,
.system-msg {
  justify-content: flex-start;
}

/* System Bubble (soft green) */
.system-msg .bubble {
  background: linear-gradient(135deg, #f4faf5, #eaf6ef);
  border: 1px solid rgba(140, 190, 160, 0.18);
  box-shadow: 0 2px 6px rgba(120, 170, 140, 0.12);
}

/* User Bubble */
.user .bubble {
  background: #e5e5ea;
  border-radius: 18px 18px 4px 18px;
}

/* Saira Bubble */
.saira-msg .bubble {
  background: linear-gradient(135deg, #fff1f6, #fde2ec);
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 2px 8px rgba(255, 160, 190, 0.18);
  border: 1px solid rgba(255, 170, 200, 0.25);
}

/* Aayan Bubble */
.aayan-msg .bubble {
  background: linear-gradient(135deg, #eef5ff, #dde9ff);
  border-radius: 18px 18px 18px 4px;
  box-shadow: 0 2px 8px rgba(120, 160, 255, 0.18);
  border: 1px solid rgba(140, 170, 255, 0.25);
}
/* =========================
   QUESTION DOCK
========================= */
.question-dock {
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid #eee;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.btn {
  padding: 6px 14px;
  border-radius: 16px;
  font-size: 13px;
  border: 1px solid #ddd;
  background: #fff;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.btn:disabled {
  opacity: 0.45;
  cursor: default;
}

.saira {
  box-shadow: 0 0 10px rgba(255,180,120,0.55);
}

.aayan {
  box-shadow: 0 0 10px rgba(120,180,255,0.55);
}
   /* Typing Animation */
.typing-bubble {
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-bubble span {
  width: 6px;
  height: 6px;
  background: #999;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}

.typing-bubble span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-bubble span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0% { opacity: 0.2; }
  20% { opacity: 1; }
  100% { opacity: 0.2; }
}
   
/* =========================
   TYPING AREA
========================= */

.typing-area {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid #eee;
}

.typing-area input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ddd;
  font-size: 14px;
  outline: none;
  transition: all 0.2s ease;
}

.typing-area input:focus {
  border-color: #bbb;
  box-shadow: 0 0 0 2px rgba(200,200,200,0.15);
}


/* =========================
   BASE BUTTON (Dock Questions)
========================= */

.btn {
  padding: 7px 16px;
  border-radius: 18px;
  font-size: 14px;
  font-weight: 500;          /* normal weight */
  letter-spacing: 0.02em;
  border: 1px solid #ddd;
  background: #fff;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.btn:disabled {
  opacity: 0.45;
  cursor: default;
}


/* =========================
   VOICE BUTTONS (Subtle Tint)
========================= */

.btn.saira {
  background: linear-gradient(135deg, #fff1f6, #fde2ec);
  border: 1px solid rgba(255,170,200,0.35);
  font-weight: 600;
}

.btn.aayan {
  background: linear-gradient(135deg, #eef5ff, #dde9ff);
  border: 1px solid rgba(140,170,255,0.35);
  font-weight: 600;
}


/* =========================
   PRIMARY BUTTONS (Send + Return)
========================= */

.typing-area button {
  padding: 8px 16px;      /* keeps original shape */
  border-radius: 18px;
  font-size: 13px;
  font-weight: 600;
  background: #222;
  color: white;
  border: none;
  cursor: pointer;
  transition: opacity 0.2s ease;
}

.typing-area button:hover {
  opacity: 0.85;
}

/* For Return to homepage */
.btn.primary {
  background: #222;
  color: white;
  border: none;
  font-weight: 600;
}

.btn.primary:hover {
  opacity: 0.85;
}


/* =========================
   TYPING INDICATOR
========================= */

#typingIndicator .bubble {
  opacity: 0.8;
  font-style: italic;
}

/* =========================
   PERMISSION PROMPT
========================= */
.reflection-prompt {
  background: #f6f1ea;
  border-left: 3px solid #d8cfc3;
  padding: 14px 16px;
  border-radius: 8px;
}

/* =========================
   TRUST PANEL (RIGHT)
========================= */
.right-column h2 {
  font-size: 22px;
  font-weight: normal;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin: 0 0 18px;
}

.right-column h2.spaced {
  margin-top: 48px;
}

.right-column h3 {
  font-size: 13px;
  letter-spacing: 0.12em;
  margin: 0 0 6px;
}

.right-column p {
  font-size: 15px;
  line-height: 1.7;
  margin: 0 0 18px;
}

/* =========================
   FOOTER
========================= */
.page-footer {
  margin-top: 80px;
  font-size: 13px;
  color: #888;
}

   /* =========================
   SCROLLBAR
========================= */

.chat-body::-webkit-scrollbar {
  width: 6px;
}

.chat-body::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.12);
  border-radius: 4px;
}

.chat-body::-webkit-scrollbar-track {
  background: transparent;
}

/* =========================
   MOBILE
========================= */
@media (max-width: 900px) {
  .layout {
    grid-template-columns: 1fr;
    gap: 60px;
  }
}
</style>
</head>

<body>

<div class="page-wrapper">

  <!-- HEADER -->
  <div class="page-header">
    <h1>Our Story</h1>
    <p>A quiet companion space for <em>Where The Sky Remembers Us</em>.</p>
  </div>

  <div class="layout">

 <!-- LEFT: BOT -->
<div class="left-column">
<div class="bot-shell">

  <div class="bot-header">
  <span class="bot-title">Where the Sky Remembers Us | Companion</span>
</div>
   
  <div class="chat-body" id="chatBody">
  <div class="sky-layer" id="skyLayer"></div>
</div>
  <div class="question-dock" id="questionDock"></div>

  <!-- TYPING AREA -->
  <div class="typing-area" id="typingArea" style="display:none;">
    <input type="text" id="userInput" placeholder="You can ask something‚Ä¶" />
    <button onclick="sendTypedMessage()">Send</button>
  </div>
</div>

    </div>

    <!-- RIGHT: TRUST / CONTACT -->
    <div class="right-column">
      <h2>Reach Out to the Author</h2>

      <h3>WEBSITE</h3>
      <p>www.wheretheskyremembersus.com</p>

      <h2 class="spaced">Privacy Note</h2>
      <p>
        We value your privacy. Information you share through our feedback form‚Äî
        such as your name, email, or message‚Äîis used solely to understand and
        respond to your feedback. We do not use cookies, trackers, or third-party tools.
      </p>

      <p>
        For any questions, contact us at:<br>
        <strong>wheretheskyremembersus@gmail.com</strong>
      </p>

      <h2 class="spaced">Communication Address</h2>
      <p>
        PO Box : 10<br>
        General Post Office<br>
        Shillong 793001<br>
        Meghalaya, India
      </p>
    </div>

  </div>

  <div class="page-footer">
  ¬© 2026 Mohan R.  
  <br>
  <em>Where The Sky Remembers Us</em>. All rights reserved.
</div>

</div>

<!-- FORM (hidden) -->
<form id="reflectionForm" action="https://formspree.io/f/xaqdqobr" method="POST" style="display:none;">
  <input type="hidden" name="voice" id="formVoice">
  <input type="hidden" name="reflection_1" id="r1">
  <input type="hidden" name="reflection_2" id="r2">
  <input type="hidden" name="reflection_3" id="r3">
  <input type="hidden" name="timestamp" id="formTime">
</form>

<script>
   
let skyLayer = document.getElementById("skyLayer");
let emotionalDepth = 0;

const chatBody = document.getElementById("chatBody");
const dock = document.getElementById("questionDock");

// Initial atmosphere reset
chatBody.style.setProperty("--overlayStrength", 0.25);
skyLayer.style.filter = "brightness(1) contrast(1) saturate(1)";
   
// Preload sky images
const preloadSaira = new Image();
preloadSaira.src = "Saira.jpg";

const preloadAayan = new Image();
preloadAayan.src = "Aayan.jpg";

/* =========================
   SOUND ENGINE
========================= */

let audioContext;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playTone(startFreq, duration, volume = 0.02, glideTo = null) {
  if (!audioContext) return;

  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();

  oscillator.type = "sine";
  oscillator.frequency.setValueAtTime(startFreq, audioContext.currentTime);

  if (glideTo) {
    oscillator.frequency.linearRampToValueAtTime(
      glideTo,
      audioContext.currentTime + duration / 1000
    );
  }

  gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(
    0.001,
    audioContext.currentTime + duration / 1000
  );

  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  oscillator.start();
  oscillator.stop(audioContext.currentTime + duration / 1000);
}

/* =========================
   HELPERS
========================= */

/* ---------- Enable Enter Key ---------- */

window.addEventListener("DOMContentLoaded", function () {
  const inputField = document.getElementById("userInput");

  if (inputField) {
    inputField.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        sendTypedMessage();
      }
    });
  }
});

/* ---------- Utility ---------- */

function clearDock() {
  if (dock) dock.innerHTML = "";
}

/* ---------- Auto Scroll ---------- */

function autoScroll() {
  if (!chatBody) return;

  chatBody.scrollTo({
    top: chatBody.scrollHeight,
    behavior: "smooth"
  });
}

/* ---------- Message Builders ---------- */

function addUserMessage(text) {
  chatBody.insertAdjacentHTML(
    "beforeend",
    `<div class="message user">
        <div class="bubble"><strong>${text}</strong></div>
     </div>`
  );
  autoScroll();
}

function addVoiceMessage(text) {
  const side =
    activeVoice === "saira"
      ? "saira-msg"
      : activeVoice === "aayan"
      ? "aayan-msg"
      : "system-msg";

  chatBody.insertAdjacentHTML(
    "beforeend",
    `<div class="message ${side}">
        <div class="bubble">${text}</div>
     </div>`
  );

  autoScroll();
}

function addSystemMessage(text) {
  chatBody.insertAdjacentHTML(
    "beforeend",
    `<div class="message system-msg">
        <div class="bubble">${text}</div>
     </div>`
  );
  autoScroll();
}

/* ---------- Typing Indicator ---------- */

function showTypingIndicator() {
  removeTypingIndicator();

  const side =
    activeVoice === "saira"
      ? "saira-msg"
      : activeVoice === "aayan"
      ? "aayan-msg"
      : "system-msg";

  chatBody.insertAdjacentHTML(
    "beforeend",
    `<div class="message ${side}" id="typingIndicator">
        <div class="bubble typing-bubble">
          <span></span>
          <span></span>
          <span></span>
        </div>
     </div>`
  );

  autoScroll();
}

function removeTypingIndicator() {
  const typing = document.getElementById("typingIndicator");
  if (typing) typing.remove();
}

/* ---------- Reply Delivery + Atmosphere Engine ---------- */

function deliverReply(replyText, callback) {
  if (!replyText || interactionLocked) return;

  interactionLocked = true;
  setDockDisabled(true);

  const delay = Math.min(
    3000,
    Math.max(700, replyText.length * 18)
  );

  // Small natural pause before typing starts
  setTimeout(() => {
    showTypingIndicator();
  }, 180);

  setTimeout(() => {
    removeTypingIndicator();

    addVoiceMessage(replyText);
    playTone(420, 120, 0.025, 360);

    /* =========================
       ATMOSPHERE PROGRESSION
    ========================= */

    emotionalDepth++;

    const depthFactor = Math.min(emotionalDepth * 0.08, 1);

    // Overlay fades gradually
    const overlayValue = Math.max(
      0.03,
      0.45 - depthFactor * 0.75
    );

    chatBody.style.setProperty(
      "--overlayStrength",
      overlayValue
    );

    // Sky cinematic evolution
    if (skyLayer) {
      skyLayer.style.filter = `
        brightness(${1 - depthFactor * 0.6})
        contrast(${1 + depthFactor * 1.5})
        saturate(${1 + depthFactor * 1.4})
      `;

      // Gentle breathing motion
      skyLayer.style.transform = "scale(1.04)";
      setTimeout(() => {
        skyLayer.style.transform = "scale(1)";
      }, 1200);
    }

    /* =========================
       UNLOCK INTERACTION
    ========================= */

    interactionLocked = false;
    setDockDisabled(false);

    if (typeof callback === "function") {
      callback();
    }

  }, delay + 180);
}


/* ---------- Dock Control ---------- */

function setDockDisabled(state) {
  const buttons = dock.querySelectorAll("button");

  buttons.forEach(btn => {
    btn.disabled = state;
    btn.style.opacity = state ? "0.5" : "1";
    btn.style.pointerEvents = state ? "none" : "auto";
  });
}

/* =========================
   INTELLIGENCE ROUTER
========================= */

function handleIntelligence(text, originalText) {

  // Prevent overlapping replies while typing
  if (interactionLocked) return false;

  const lower = text.toLowerCase().trim();

 /* 1Ô∏è‚É£ SPECIFIC GREETINGS FIRST */

/* 1.1Ô∏è‚É£ HEY THERE / HELLO THERE */
if (/^(hey there|hello there)\b/i.test(lower)) {

  if (lower.startsWith("hey")) {
    deliverReply("Hi!");
  } else {
    deliverReply("Hello!");
  }

  return true;
}

/* 1.2Ô∏è‚É£ PRESENCE CHECK */
if (/^(you there|are you there)\b/i.test(lower)) {
  deliverReply("Yes, I am.");
  return true;
}

/* 1.3Ô∏è‚É£ TIME GREETINGS */
if (/^(good morning|morning|gdnite|good afternoon|good day|good evening|good night|good nite)\b/i.test(lower)) {

  const formatted = lower
    .split(" ")
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");

  deliverReply(formatted + "!");
  return true;
}

/* 1Ô∏è‚É£ GENERAL HI / HELLO / HEY */
if (/^(hi|hello|hey)\b/i.test(lower)) {

  const words = lower.split(" ");
  const secondWord = words[1];

  if (!secondWord) {
    deliverReply(lower.startsWith("hello") ? "Hello!" : "Hi!");
    return true;
  }

  if (secondWord === activeVoice) {
    deliverReply(lower.startsWith("hello") ? "Hello!" : "Hi!");
    return true;
  }

  if (
    (secondWord === "saira" && activeVoice === "aayan") ||
    (secondWord === "aayan" && activeVoice === "saira")
  ) {
    deliverReply(
      activeVoice === "saira"
        ? "He isn‚Äôt here."
        : "She isn‚Äôt here."
    );
    return true;
  }

  return false;
}

 /* 1.5Ô∏è‚É£ USER INTRODUCTION */
if (/(i am|i'm|my name is)/.test(lower)) {

  const words = originalText.split(" ");
  const name = words[words.length - 1].replace(/[^a-zA-Z]/g, "");

  const reply = name.length > 1
    ? `It‚Äôs good to meet you, ${name}.`
    : "It‚Äôs good to meet you.";

  deliverReply(reply);
  return true;
}
   
  /* 1.6Ô∏è‚É£ USER GRATITUDE */

if (/(thank you|thankyou|thanks|thank|appreciate|great|thx|excellent|cheers)/i.test(lower)) {
  deliverReply("You‚Äôre welcome.");
  return true;
}
   /* 1.7Ô∏è‚É£ EXIT / GOODBYE */

if (/(bye|bye bye|cya|c u later|see you|see you soon|see you again|tata|tada|take care|goodbye)/i.test(lower)) {

  const reply = activeVoice === "saira"
    ? "Goodbye. Take care."
    : "Goodbye.";

  deliverReply(reply);
  return true;
}
   /* 1.6Ô∏è‚É£ COMPLIMENTS */

if (/(beautiful|lovely|amazing|great|wonderful|inspiring|brilliant|nice|incredible|awesome|fantastic|perfect|proud of you)/i.test(lower)) {

  const reply = activeVoice === "saira"
    ? "That‚Äôs kind of you."
    : "I appreciate that.";

  deliverReply(reply);
  return true;
}

  /* 2Ô∏è‚É£ VOICE IDENTITY */
  if (/(what is your name|who are you|your name)/.test(lower)) {
    const reply = activeVoice === "saira"
      ? "I‚Äôm Saira."
      : "Aayan.";

    deliverReply(reply);
    return true;
  }

  /* 3Ô∏è‚É£ DIRECT NAME CALL */
  if (/^(saira|aayan)$/i.test(lower)) {

    if (lower === activeVoice) {
      deliverReply("I‚Äôm here.");
    } else {
      deliverReply(
        activeVoice === "saira"
          ? "He isn‚Äôt here."
          : "She isn‚Äôt here."
      );
    }

    return true;
  }

  /* 4Ô∏è‚É£ BUY */
  if (/(buy|purchase|order|get|price|cost)/.test(lower)) {
    const reply = activeVoice === "saira"
      ? "You can find our story in the format that feels closest to you ‚Äî digital, print, or audio."
      : "It‚Äôs available in digital, print, and audio. The form doesn‚Äôt change what it carries.";

    deliverReply(reply);
    return true;
  }

  /* 5Ô∏è‚É£ SEQUEL */
  if (/(part 2|sequel|next book|continue|future|more)/.test(lower)) {
    const reply = activeVoice === "saira"
      ? "Stories don‚Äôt end. They change shape."
      : "What mattered didn‚Äôt disappear.";

    deliverReply(reply);
    return true;
  }

  /* 6Ô∏è‚É£ TECHNICAL */
  if (/(not working|frozen|stuck|not loading|can't click|cannot click)/.test(lower)) {
    const reply = activeVoice === "saira"
      ? "If something feels out of place, refresh and begin again."
      : "If it falters, refresh and return.";

    deliverReply(reply);
    return true;
  }

  /* 7Ô∏è‚É£ EMOTIONAL */
  if (/(sad|hurt|pain|broken|cry|regret|angry|unfair|lost|heartbroken|disappointed|didn't like|bad ending|hate you)/.test(lower)) {

    let reply;

    if (activeVoice === "saira") {
      reply = emotionalToggle
        ? "Not everything needs to be resolved to be real."
        : "Some feelings don‚Äôt ask for answers. They just stay.";
    } else {
      reply = emotionalToggle
        ? "Some things are understood without being solved."
        : "Not everything that hurts needs explaining.";
    }

    emotionalToggle = !emotionalToggle;
    deliverReply(reply);
    return true;
  }

  /* 8Ô∏è‚É£ ABUSE (voice targeted only) */
  if (/(stupid|idiot|dumb|shut up|useless|worthless|trash|fuck you|screw you)/.test(lower)
      && /(you|saira|aayan)/.test(lower)) {

    const reply = activeVoice === "saira"
      ? "I won‚Äôt stay where respect isn‚Äôt present."
      : "If this turns careless, I‚Äôll remain silent.";

    deliverReply(reply);
    return true;
  }

  /* 9Ô∏è‚É£ FOREIGN / RANDOM */
  if (!/[a-z]/i.test(originalText)) {
    const reply = activeVoice === "saira"
      ? "I may not understand that ‚Äî but I‚Äôm still here."
      : "Some words don‚Äôt reach me. Try again.";

    deliverReply(reply);
    return true;
  }

  return false;
}

/* ---------- Typed Input Handler ---------- */

function sendTypedMessage() {

  const input = document.getElementById("userInput");
  if (!input) return;

  const originalText = input.value.trim();
  if (!originalText) return;

  // IMPORTANT: Voice must be selected
  if (!activeVoice) {
    addSystemMessage("Please choose Saira or Aayan first.");
    return;
  }

  addUserMessage(originalText);
playTone(520, 60, 0.025);

  const text = originalText.toLowerCase();

  // üî• Intelligence router first
  if (handleIntelligence(text, originalText)) {
    return;
  }

  // üîÅ Existing mirror logic

  let reply;

  if (text.includes("meet") || text.includes("first time")) {
    reply = activeVoice === "saira"
      ? "We didn‚Äôt meet gently. It began with headlights and argument."
      : "It started with brakes and irritation. Not romance.";
  }

  else if (text.includes("love") || text.includes("feel")) {
    reply = activeVoice === "saira"
      ? "Love arrived quietly. It didn‚Äôt ask permission."
      : "Love requires surrender. That wasn‚Äôt easy for me.";
  }

  else if (text.includes("end") || text.includes("together")) {
    reply = activeVoice === "saira"
      ? "Not all endings are conclusions."
      : "What mattered didn‚Äôt disappear.";
  }

  else if (/(who.*author|about.*author|who wrote|author)/.test(text)) {
  reply = activeVoice === "saira"
    ? "He wrote this honestly. That was enough."
    : "He chose truth over comfort.";
}

  else {
    reply = activeVoice === "saira"
      ? "I don‚Äôt always have the right words ‚Äî but I‚Äôm listening."
      : "Some questions don‚Äôt need quick answers.";
  }

  deliverReply(reply);
}
/* ---------- Utility ---------- */

function clearDock() {
  if (dock) dock.innerHTML = "";
}

function returnToWebsite() {
  window.location.href = "https://wheretheskyremembersus.com";
}

/* =========================
   INIT
========================= */

function loadWelcome() {
  chatBody.innerHTML = '<div class="sky-layer" id="skyLayer"></div>';
  skyLayer = document.getElementById("skyLayer");
   skyLayer.style.opacity = "1";
   
   emotionalDepth = 0;
chatBody.style.setProperty("--overlayStrength", 0.45);
skyLayer.style.filter = "brightness(1) contrast(1) saturate(1)";


  // FULL RESET
  activeVoice = null;
foundationalAnswered = new Set();
characterAnswered = 0;
currentLayer = 0;
reflections = [];
reflectionStep = 0;
interactionLocked = false; // reset lock
   
  const welcomeMessages = [
    "Hello.",
    "This is a quiet space.",
    "You can listen to our story through Saira or Aayan.",
    "Our story is a contemporary romantic fiction.",
    "When you‚Äôre ready, you can choose a voice."
  ];

  // Neutral opening messages (no voice colour)
  welcomeMessages.forEach(text => {
  addSystemMessage(text);
});

  clearDock();

  dock.innerHTML = `
    <button class="btn saira" onclick="selectVoice('saira')">Saira</button>
    <button class="btn aayan" onclick="selectVoice('aayan')">Aayan</button>
  `;

  autoScroll();
}

/* =========================
   VOICE SELECTION
========================= */
function selectVoice(v) {
emotionalDepth = 0;
chatBody.style.setProperty("--overlayStrength", 0.45);
skyLayer.style.filter = "brightness(1) contrast(1) saturate(1)";
   
  initAudio();   // ‚Üê ADD THIS LINE

  interactionLocked = false; // reset lock

  activeVoice = v;
  const header = document.querySelector(".bot-header");

if (v === "saira") {
  header.style.background = "linear-gradient(135deg, #f8eef2, #f2e4ea)";
} else {
  header.style.background = "linear-gradient(135deg, #eef3fb, #e3ebf9)";
}
 if (v === "saira") {
  skyLayer.style.opacity = "0";
  setTimeout(() => {
    skyLayer.style.backgroundImage = "url('Saira.jpg')";
    skyLayer.style.opacity = "1";
  }, 200);
} else {
  skyLayer.style.opacity = "0";
  setTimeout(() => {
    skyLayer.style.backgroundImage = "url('Aayan.jpg')";
    skyLayer.style.opacity = "1";
  }, 200);
}
   clearDock();
  document.getElementById("typingArea").style.display = "flex";

  const intro =
    v === "saira"
      ? "Hello, this is Saira. I don‚Äôt believe stories are meant to be explained too quickly ‚Äî but I can sit with you and share what ours carries."
      : "Hello. This is Aayan. I don‚Äôt speak easily about what stayed behind, but I can tell you what it asked of us.";

 setTimeout(() => {
  showTypingIndicator();

  setTimeout(() => {
    removeTypingIndicator();
    addVoiceMessage(intro);
    showFoundational();
  }, 900);

}, 250);

}
   
/* =========================
   FOUNDATIONAL
========================= */
function showFoundational() {
  clearDock();

  const questions = [
    { text: "What kind of story is this?", key: "story" },
    { text: "What is the story about?", key: "about" },
    { text: "Who is this story for?", key: "for" },
    { text: "Where can I read it?", key: "where" },
    { text: "Who is the author?", key: "author" }
  ];

  questions.forEach(q => {
    const btn = document.createElement("button");
    btn.className = "btn " + activeVoice;
    btn.textContent = q.text;
    btn.onclick = () => answerFoundational(q, btn);
    dock.appendChild(btn);
  });
}

function answerFoundational(q, btn) {
  if (interactionLocked) {
    const msg = activeVoice === "saira"
      ? "Let me finish this gently‚Ä¶ üåô"
      : "Give it a moment. I‚Äôm still here. üåø";
    addVoiceMessage(msg);
    return;
  }

  btn.remove();
  foundationalAnswered.add(q.key);

  addUserMessage(q.text);
  playTone(520, 60, 0.02);

  const replies = {
  saira: {
    story: "Our story is a contemporary romantic fiction ‚Äî but it moves quietly. It lingers in moments that don‚Äôt seem significant at first, and then refuses to leave you. It‚Äôs less about grand declarations, and more about what remains unsaid.",
    
    about: "It‚Äôs about me and Aayan ‚Äî about the kind of love that feels certain, even when life around it isn‚Äôt. It‚Äôs about distance that isn‚Äôt always physical, and choices that seem small until they change everything. Some stories are built on moments. Ours was built on hesitation.",
    
    for: "This story finds people who have felt something deeply and didn‚Äôt know what to do with it. The ones who replay conversations long after they‚Äôve ended. If you‚Äôve ever stood between love and fear ‚Äî you already understand us.",
    
    where: "You can find our story in whatever form feels closest to you ‚Äî as a Kindle eBook, in paperback, hardcover, or even as an audiobook. Some prefer to hold it. Some prefer to listen. However you choose, the story remains the same.",
    
    author: "Mohan R. wrote this as his debut novel. He didn‚Äôt try to make it loud ‚Äî only honest. I think he trusted silence as much as dialogue, and allowed the pauses to speak."
  },
  aayan: {
    story: "It‚Äôs a contemporary romantic fiction, but it lives in the space between love and responsibility. It‚Äôs about choices that don‚Äôt feel urgent ‚Äî until they are. And about how easily silence can become distance.",
    
    about: "It‚Äôs about timing ‚Äî but not in the simple way people think. The feeling was never uncertain. What faltered was courage, and the belief that love would wait. It‚Äôs about how easily something real can slip into memory if you hesitate too long.",
    
    for: "It‚Äôs for those who believe feelings can wait ‚Äî until they realise they can‚Äôt. For people who have chosen responsibility over vulnerability, and wondered about the cost later. If you‚Äôve ever hesitated when it mattered most, this story will feel familiar.",
    
    where: "It‚Äôs available in digital, print, and audio formats. The format doesn‚Äôt change what it carries ‚Äî only how you meet it. Some stories are read. Some are heard. Ours survives both.",
    
    author: "Mohan R. wrote this story. Not to explain everything ‚Äî but to sit with what lingers after love shifts. Some things are written for applause. This wasn‚Äôt one of them."
  }
};

  const reply = replies[activeVoice][q.key];

  deliverReply(reply, function () {

    if (foundationalAnswered.size === 5) {
      unlockNextLayer();
    }

  });
}

/* =========================
   15 CHARACTER QUESTIONS
========================= */

const characterLayers = [
  // Layer 1 (5)
  [
  {
    q: "Where did you first meet?",
    a: {
      saira: "We didn‚Äôt meet gently. I stepped into traffic for a photograph, and he nearly ran me over. There were headlights, brakes, rain on the road ‚Äî and his voice, sharp and unamused. I remember the irritation first. The way he looked at me like I was a problem. But beneath it‚Ä¶ something sparked that neither of us understood.",
      aayan: "She walked into the road without looking. I slammed the brakes harder than I‚Äôve ever had to. She should have been shaken ‚Äî but she argued instead. Bold. Annoying. Completely unafraid of me. I told myself it was just frustration. It wasn‚Äôt."
    }
  },
  {
    q: "What did you first notice?",
    a: {
      saira: "I noticed how controlled he was. Even angry, he didn‚Äôt raise his voice ‚Äî he just sharpened it. He looked at me like I was reckless, inconvenient. But there was something else in his eyes too ‚Äî something calculating, almost curious. And that unsettled me more than the anger did.",
      aayan: "I noticed that she wasn‚Äôt intimidated. Most people step back when challenged. She stepped closer. Even with a twisted ankle, she refused to yield. There was defiance in her ‚Äî not loud, not dramatic ‚Äî just steady. And I wasn‚Äôt used to that."
    }
  },
  {
   q: "When did you start feeling it was more than temporary?",
    a: {
      saira: "It wasn‚Äôt in Mumbai. That was just fire. It was in Venice. We were walking without speaking, the canals quiet around us, and for the first time I wasn‚Äôt arguing with him. I was just‚Ä¶ at ease. That frightened me more than the chaos ever had.",
      aayan: "I don‚Äôt believe in 'the one.' I believe in discipline, in clarity. But there was a moment when I stopped calculating and just watched her. She was laughing ‚Äî unguarded, unaware that I was noticing the way she softened when she forgot to defend herself. That was when I realised she was no longer temporary."
    }
  },
  {
    q: "Who admitted their feelings first?",
    a: {
      saira: "I felt it first, but he was the one who said it. Though he had been carrying it just as long. I think he needed certainty before he allowed himself to be vulnerable.",
      aayan: "I did. But I think she knew before I did. I tend to weigh words before I let them go. Once I say something, I don‚Äôt take it back."
    }
  },
  {
    q: "Which was the first city you were together in?",
    a: {
      saira: "As a couple, it wasn‚Äôt Mumbai. It was our trip through Manali, Spiti, and Shimla. Five days that were meant to be brief ‚Äî but stretched longer than we expected. Somewhere between the cold air and the quiet roads, the tension eased. That was the first time it felt like we were choosing each other.",
      aayan: "The first time we were truly together was during that trip through Manali, Spiti, and Shimla. It wasn‚Äôt planned as something significant. But distance from the city changed the way we moved around each other. We stayed two extra days. I don‚Äôt extend time for things that don‚Äôt matter."
    }
  }
],

  // Layer 2 (5)
[
  {
    q: "Did you ever question your choice?",
    a: {
      saira: "Yes. Loving someone deeply doesn‚Äôt silence doubt ‚Äî it makes it more complicated. I questioned myself more than I questioned him, and that uncertainty lingered longer than I expected.",
      aayan: "I questioned the timing more than the feeling. The feeling was never uncertain ‚Äî but I wasn‚Äôt sure I was ready for its consequences."
    }
  },
  {
    q: "Were you ever afraid of loving each other?",
    a: {
      saira: "I was afraid of losing him, not loving him. Losing something that felt certain frightened me more than the feeling itself, because certainty had always felt fragile in my life.",
      aayan: "Yes. Love asks you to give up control. And I had built my life around control ‚Äî structure, decisions, outcomes I could predict."
    }
  },
  {
    q: "What was your happiest moment together?",
    a: {
      saira: "It wasn‚Äôt dramatic. It was the night before we left Goa. Nothing extraordinary happened ‚Äî except that we were both at peace, and that felt rare in a life that rarely slowed down.",
      aayan: "Silence. Sitting beside her at Triveni Ghat, without needing to explain anything. That kind of understanding doesn‚Äôt come easily, especially to someone like me."
    }
  },
  {
    q: "What moment stayed with you the longest?",
    a: {
      saira: "The moments when fear tried to take the place of love ‚Äî and I let it. I replayed those moments more than the happy ones.",
      aayan: "The look she gave me when she understood what I couldn‚Äôt say. It stayed longer than the words would have, because silence sometimes reveals more than speech."
    }
  },
  {
    q: "Which chapter feels closest to your heart?",
    a: {
      saira: "The one where everything felt possible ‚Äî before doubt began to speak louder and before I allowed fear to interrupt something beautiful.",
      aayan: "The one where everything felt uncertain ‚Äî because that‚Äôs when I realised what was at stake, even if I didn‚Äôt admit it aloud."
    }
  }
],

 // Layer 3 (5)
[
  {
    q: "Did you finally meet again?",
    a: {
      saira: "Not in the way people imagine. But I stopped running ‚Äî from him, and from myself. That mattered more than proximity ever did.",
      aayan: "No. And yes. We didn‚Äôt stand face to face again. But after her, I stopped running ‚Äî from responsibility, from legacy, from the dreams I once resisted. Some absences don‚Äôt fade. They clarify."
    }
  },
  {
    q: "Is there more to your story?",
    a: {
      saira: "There is more. I finally chose courage over fear. And when fear stops deciding your life, the future rearranges itself.",
      aayan: "There is more. I‚Äôve been building something meant to endure ‚Äî not just for this season, but beyond it. Some foundations are laid in silence before they rise into something undeniable."
    }
  },
  {
    q: "Will there be a part two?",
    a: {
      saira: "Destiny doesn‚Äôt disappear because we hesitate. If there is another chapter, it won‚Äôt be accidental. It will be earned.",
      aayan: "Some stories aren‚Äôt finished ‚Äî they pause. When timing aligns with strength, what was unfinished has a way of returning."
    }
  },
  {
    q: "If readers could learn one thing from you?",
    a: {
      saira: "Don‚Äôt let fear disguise itself as logic. Courage may feel dangerous ‚Äî but regret lasts longer.",
      aayan: "Build something worthy of return. Whether it‚Äôs love, purpose, or legacy ‚Äî make it strong enough to survive distance."
    }
  },
  {
    q: "Do you still think about each other?",
    a: {
      saira: "Yes. Not as a wound ‚Äî but as a turning point. Some people enter your life to wake you up.",
      aayan: "Yes. Not with longing. With awareness. Some connections are not meant to fade ‚Äî they are meant to mature."
    }
  }
]
];

function unlockNextLayer() {
  if (currentLayer >= characterLayers.length) return;

  clearDock();

  addSystemMessage("There‚Äôs more, if you‚Äôd like to continue.");

  setTimeout(() => {
    dock.innerHTML = `
      <button class="btn ${activeVoice}" onclick="showNextLayer()">Yes</button>
      <button class="btn" onclick="declineLayer()">No</button>
    `;
    autoScroll();
  }, 600);
}

function showNextLayer() {
  clearDock();

  characterLayers[currentLayer].forEach(item => {
    const btn = document.createElement("button");
    btn.className = "btn " + activeVoice;
    btn.textContent = item.q;
    btn.onclick = () => answerCharacter(item, btn);
    dock.appendChild(btn);
  });

  currentLayer++;
}

function answerCharacter(item, btn) {

  if (interactionLocked) {
    const msg = activeVoice === "saira"
      ? "Let me finish this gently‚Ä¶ üåô"
      : "Give it a moment. I‚Äôm still here. üåø";
    addVoiceMessage(msg);
    return;
  }

  btn.remove();

  addUserMessage(item.q);
  playTone(520, 60, 0.02);

  const reply = item.a[activeVoice];

  deliverReply(reply, function () {
    characterAnswered++;

    if (characterAnswered % 5 === 0 && characterAnswered < 15) {
      unlockNextLayer();
    }

    if (characterAnswered === 15) {
      showAuthorInvitation();
    }
  });
}

/* =========================
   AUTHOR INVITATION
========================= */

function showAuthorInvitation() {
  clearDock();

  addSystemMessage("You‚Äôve stayed with us until the end.");

setTimeout(() => {
  addSystemMessage("If you‚Äôd like to write to the author, you‚Äôre welcome to. He occasionally shares digital copies with readers who reach out thoughtfully.");
}, 500);

setTimeout(() => {
  addSystemMessage("wheretheskyremembersus@gmail.com");
}, 900);

setTimeout(() => {
  addSystemMessage("Before you leave, may I ask you three quiet reflections?");
}, 1300);

  setTimeout(() => {
  dock.innerHTML = `
    <button class="btn ${activeVoice}" onclick="startReflection()">Yes</button>
    <button class="btn" onclick="declineReflection()">No</button>
  `;
}, 1500);
} 

function declineLayer() {
  playTone(520, 60, 0.02);

  clearDock();

  addSystemMessage(
    activeVoice === "saira"
      ? "Thank you for sitting with us."
      : "Thank you for staying."
  );

  dock.innerHTML = `
    <button class="btn saira" onclick="selectVoice('saira')">Saira</button>
    <button class="btn aayan" onclick="selectVoice('aayan')">Aayan</button>
    <button class="btn" onclick="returnToWebsite()">Return to the main site</button>
  `;

  autoScroll();
}

/* =========================
   REFLECTION
========================= */

function declineReflection() {
  playTone(520, 60, 0.02);

  clearDock();

  addSystemMessage(
  activeVoice === "saira"
    ? "Thank you for sitting with us."
    : "Thank you for staying."
);

  dock.innerHTML = `
    <button class="btn" onclick="returnToWebsite()">Return to the main site</button>
  `;
}
   
function startReflection() {
  playTone(520, 60, 0.02);

  reflections = [];
  reflectionStep = 0;
  nextReflection();
}

function nextReflection() {
  const sets = {
    saira: [
      ["How closely did this story stay with you?", ["üå´Ô∏è","üå±","üíõ","üåô","‚ú®"]],
      ["How clearly did the emotions feel?", ["üå´Ô∏è","üå±","üíõ","üåô","‚ú®"]],
      ["How drawn do you feel to continue?", ["üö∂","üëÄ","üí´","‚ù§Ô∏è","üìñ"]]
    ],
    aayan: [
      ["How clearly did the emotional world reveal itself to you?", ["üåë","üåò","üåó","üåï","‚òÄÔ∏è"]],
      ["How steady did the story feel?", ["üåë","üåò","üåó","üåï","‚òÄÔ∏è"]],
      ["How drawn do you feel to continue reading?", ["üö∂","üëÄ","üí´","‚ù§Ô∏è","üìñ"]]
    ]
  };

  if (reflectionStep === 3) {
    submitReflection();
    return;
  }

  clearDock();

  const [question, emojis] = sets[activeVoice][reflectionStep];

  addSystemMessage(question);

  emojis.forEach(e => {
    const btn = document.createElement("button");
    btn.className = "btn " + activeVoice;
    btn.textContent = e;
    btn.onclick = () => {
      playTone(520, 60, 0.02);   // ‚Üê add sound here for emoji clicks
      reflections.push(e);
      reflectionStep++;
      nextReflection();
    };
    dock.appendChild(btn);
  });
}

/* =========================
   SUBMIT
========================= */

function submitReflection() {
  document.getElementById("formVoice").value = activeVoice;
  document.getElementById("r1").value = reflections[0];
  document.getElementById("r2").value = reflections[1];
  document.getElementById("r3").value = reflections[2];
  document.getElementById("formTime").value = new Date().toISOString();
  document.getElementById("reflectionForm").submit();

  dock.innerHTML = "";

  chatBody.insertAdjacentHTML(
  "beforeend",
  `<div class="message ${activeVoice === "saira" ? "saira-msg" : "aayan-msg"}">
     <div class="bubble">
       ${activeVoice === "saira"
         ? "Thank you for sitting with us. It means more than you know."
         : "Thank you for staying. Not everyone chooses to listen this closely."}
       <br><br>
       <button class="btn primary" onclick="returnToWebsite()">Return to the main site</button>
     </div>
   </div>`
);

  autoScroll();
}

/* =========================
   START
========================= */

loadWelcome();
   
</script>
